<html>
<head>
<link type="text/css" href="http://jqueryui.com/themes/base/ui.all.css" rel="stylesheet">
<style>
div, td, th { color: black; }
</style>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.10/jquery-ui.min.js"></script>
<script>
  // Search the bookmarks when entering the search keyword.
  $(function() {
    $('#search').change(function() {
       $('#bookmarks').empty();
       // dumpBookmarks($('#search').val());
       searchKey($('#search').val());
    });
  });
  // Find bookmark with [] in the end of title
  function searchKey(key) {
      var regex = '.*\\[' + key + '\\]$';
      console.log('Search with key, regex', key, regex);
      var pattern = new RegExp(regex);
      var search = function(bookmarkTreeNodes) {
          $.each(bookmarkTreeNodes, function(index, node) {
              if (node.children && node.children.length > 0) {
                  search(node.children);
              } else {
                var match = pattern.exec(node.title);
                if (match != null) {
                    console.log('Match found', node);
                    chrome.tabs.create({url: node.url});
                }
              }
          });
      };
      chrome.bookmarks.getTree(search);
  }


  // Traverse the bookmark tree, and print the folder and nodes.
  function dumpBookmarks(query) {
      console.log('Search with query:', query);
      var dumpResult = function(results) {
          console.log('Results:', results);
          dumpTreeNodes(results, query);
      }
      chrome.bookmarks.search(query, dumpResult);
  }

  function dumpTreeNodes(bookmarkNodes, query) {
    var list = $('<ul>');
    var i;
    for (i = 0; i < bookmarkNodes.length; i++) {
      list.append(dumpNode(bookmarkNodes[i], query));
    }
    return list;
  }
  function dumpNode(bookmarkNode, query) {
    if (bookmarkNode.title) {
      if (query && !bookmarkNode.children) {
        if (String(bookmarkNode.title).indexOf(query) == -1) {
          return $('<span></span>');
        }
      }
      var anchor = $('<a>');
      anchor.attr('href', bookmarkNode.url);
      anchor.text(bookmarkNode.title);
      /*
       * When clicking on a bookmark in the extension, a new tab is fired with
       * the bookmark url.
       */
      anchor.click(function() {
        chrome.tabs.create({url: bookmarkNode.url});
      });
      var span = $('<span>');
      var options = bookmarkNode.children ?
        $('<span>[<a href="#" id="addlink">Add</a>]</span>') :
        $('<span>[<a id="editlink" href="#">Edit</a> <a id="deletelink" ' +
          'href="#">Delete</a>]</span>');
      var edit = bookmarkNode.children ? $('<table><tr><td>Name</td><td>' +
        '<input id="title"></td></tr><tr><td>URL</td><td><input id="url">' +
        '</td></tr></table>') : $('<input>');
      // Show add and edit links when hover over.
          span.hover(function() {
          span.append(options);
          options.fadeIn();
        },
        // unhover
        function() {
          options.remove();
        }).append(anchor);
    }
    var li = $(bookmarkNode.title ? '<li>' : '<div>').append(span);
    if (bookmarkNode.children && bookmarkNode.children.length > 0) {
      li.append(dumpTreeNodes(bookmarkNode.children, query));
    }
    return li;
  }
</script>
</head>
<body onload="dumpBookmarks();" style="width: 400px">
<div>Search Bookmarks: <input id="search"></div>
<div id="bookmarks"></div>
<div id="editdialog"></div>
<div id="deletedialog"></div>
<div id="adddialog"></div>
</body>
</html>
